<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>个人中心</title>
    <link rel="stylesheet" href="pintereso/assets/css/app.css" />
    <link rel="stylesheet" href="pintereso/assets/css/theme.css" />
    <link rel="stylesheet" href="pintereso/assets/css/font-awesome.min.css" />
    <script src="js/jquery-3.6.1.min.js"></script>
    <script src="js/sweetalert2@11.js"></script>
    <style>
      .card-img {
        width: 270px; /* 设置图片框的固定宽度 */
        height: 150px; /* 设置图片框的固定高度 */
        object-fit: cover; /* 确保图片覆盖整个框，同时保持图片的宽高比 */
      }


    </style>
    <script>
      $(document).ready(function () {
        var token = sessionStorage.getItem("token");
        var newHref = "/upload?token=" + token;
        $("#uploadHref").attr("href", newHref);

        fetchImages(1);
      });
      function logout() {
        sessionStorage.clear();
        window.location.replace("/");
      }

      function deleteImage(element) {
        // 弹出确认框
        Swal.fire({
          title: "确定要删除这张图片吗？",
          text: "删除后将无法恢复！",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#3085d6",
          cancelButtonColor: "#d33",
          confirmButtonText: "是的，删除它！",
        }).then((result) => {
          if (result.isConfirmed) {
            var token = sessionStorage.getItem("token");
            var imageId = element.value; // 获取按钮的value，即imageId
            console.log(token);
            console.log(imageId);
            // 发送删除请求
            $.ajax({
              type: "POST",
              url: "/service/delete",
              data: {
                imageId: imageId,
                token: token,
              },
              success: function (response) {
                Swal.fire("删除成功！", "好的", "message").then(function() {
                  location.reload(); // 刷新页面
                });
                
                // 在成功删除后刷新页面或者移除被删除的图片卡片
                //location.reload(); // 刷新页面
                // 或者
                // $("#imageCard" + imageId).remove(); // 移除被删除的图片卡片
              },
              error: function (xhr, status, error) {
                // 处理删除失败的情况
                Swal.fire("删除失败！", "发生了一个错误，请重试。", "error");
              },
            });
          }
        });
      }

      function modifyImage(element) {
        var token = sessionStorage.getItem("token");
        var imageId = element.value; // 获取按钮的value，即imageId
        console.log(token);
        console.log(imageId);

        window.location.replace(
          "/modify?imageId=" + imageId + "&token=" + token
        );
      }

      function fetchImages(page) {
        var token = sessionStorage.getItem("token");
        $.ajax({
          type: "POST",
          url: "/service/getUserImageCount",
          data: {
            token: token,
          },
          success: function (response) {
            res = JSON.parse(response);
            if (res["code"] == 200) {
              imageCnt = res["data"];
              console.log(imageCnt);
              console.log("Total image count: ", imageCnt);
              totalPages = parseInt(imageCnt / 25) + 1;
              console.log("Total page count: ", totalPages);
              $.ajax({
                type: "POST",
                url: "/service/getUserImageByPage",
                data: {
                  token: token,
                  page: page,
                },
                success: function (response) {
                  // 更新图像显示
                  res = JSON.parse(response);
                  if (res["code"] == 200) {
                    updateImageCards(res["data"]);
                    console.log(totalPages);
                    updatePagination(page, totalPages);
                    $("#pageCountMax").text("/" + totalPages+""); // 更新最大页数显示
                  } else {
                    var uploadingAlert = Swal.fire({
                      title: "错误！" + res["code"] + ", " + res["msg"],
                      text: "错误！" + res["code"] + ", " + res["msg"],
                      icon: "error",
                      showConfirmButton: false,
                      allowOutsideClick: false,
                      allowEscapeKey: false,
                      allowEnterKey: false,
                    });
                    setTimeout(function () {
                      uploadingAlert.close(); // 关闭提示框
                    }, 5000);
                  }
                },
                error: function (xhr, status, error) {
                  // 处理错误
                },
              });
            } else {
              var uploadingAlert = Swal.fire({
                title: "错误！" + res["code"] + ", " + res["msg"],
                text: "错误！" + res["code"] + ", " + res["msg"],
                icon: "error",
                showConfirmButton: false,
                allowOutsideClick: false,
                allowEscapeKey: false,
                allowEnterKey: false,
              });
              setTimeout(function () {
                uploadingAlert.close(); // 关闭提示框
              }, 5000);
            }
          },
        });
      }

      function updateImageCards(images) {
        var imageCardColumnsDiv = $("#imageCardColumnsDiv");
        imageCardColumnsDiv.empty(); // 清空原有内容
        console.log(images);
        var token = sessionStorage.getItem("token");
        if (token == undefined) {
          var uploadingAlert = Swal.fire({
            title: "错误！您没有登录",
            text: "错误！您没有登录",
            icon: "error",
            showConfirmButton: false,
            allowOutsideClick: false,
            allowEscapeKey: false,
            allowEnterKey: false,
          });
          setTimeout(function () {
            uploadingAlert.close(); // 关闭提示框
          }, 5000);

          window.location.replace("login");

          return;
        }
        images.forEach(function (image) {
          if (image.typeId == 1) {
            var cardHtml = `
                    <div class="card card-pin">
                        <img class="card-img" src="uploadfile/image_pano/${image.imageId}/thumb.jpg" alt="Card image" onerror="this.onerror=null;this.src='images/image_error.jpg';this.style.width='200px';this.style.height='150px';">
                        <div class="overlay">
                            <a href="map_pano?v=${image.imageId}&token=${token}">
                                <h2 class="card-title title">${image.imageName}</h2>
                            </a>
                            <div class="more">
                                <a class="btn btn-primary" href="map_pano?v=${image.imageId}&token=${token}"><i class="fa fa-arrow-circle-o-right"></i> 查看</a>
                                <button value="${image.imageId}" onclick='deleteImage(this)'><i class="fa fa-trash"></i> 删除</button>
                                <button value="${image.imageId}" onclick='modifyImage(this)'><i class="fa fa-pencil"></i> 修改</button>
                            </div>
                        </div>
                    </div>`;
            imageCardColumnsDiv.append(cardHtml);
          } else if (image.typeId == 2) {
            var cardHtml = `
                    <div class="card card-pin">
                        <img class="card-img" src="uploadfile/image_normal/${image.imageId}/thumb.jpg" alt="Card image" onerror="this.onerror=null;this.src='images/image_error.jpg';this.style.width='200px';this.style.height='150px';">
                        <div class="overlay">
                            <a href="image?v=${image.imageId}&token=${token}">
                                <h2 class="card-title title">${image.imageName}</h2>
                            </a>
                            <div class="more">
                                <a class="btn btn-primary" href="image?v=${image.imageId}&token=${token}"><i class="fa fa-arrow-circle-o-right"></i> 查看</a>
                                <button value="${image.imageId}" onclick='deleteImage(this)'><i class="fa fa-trash"></i> 删除</button>
                                <button value="${image.imageId}" onclick='modifyImage(this)'><i class="fa fa-pencil"></i> 修改</button>
                            </div>
                        </div>
                    </div>`;
            imageCardColumnsDiv.append(cardHtml);
          }
		  else{
			var cardHtml = `
                    <div class="card card-pin">
                        <img class="card-img" src="uploadfile/image_normal/${image.imageId}/thumb.jpg" alt="Card image" onerror="this.onerror=null;this.src='images/image_error.jpg';this.style.width='200px';this.style.height='150px';">
                        <div class="overlay">
                            <a href="image?v=${image.imageId}&token=${token}">
                                <h2 class="card-title title">${image.imageName}</h2>
                            </a>
                            <div class="more">
                                <a class="btn btn-primary" href="image?v=${image.imageId}&token=${token}"><i class="fa fa-arrow-circle-o-right"></i> 查看</a>
                                <button value="${image.imageId}" onclick='deleteImage(this)'><i class="fa fa-trash"></i> 删除</button>
                                <button value="${image.imageId}" onclick='modifyImage(this)'><i class="fa fa-pencil"></i> 修改</button>
                            </div>
                        </div>
                    </div>`;
            imageCardColumnsDiv.append(cardHtml);
		  }
        });
      }

      function updatePagination(currentPage, totalPages) {
        var pagination = $("#pagination");
        pagination.empty(); // 清空原有内容

        // 上一页按钮
        var prevButton = `
        <li class="page-item ${currentPage === 1 ? "disabled" : ""}">
            <a class="page-link" href="#" onclick="fetchImages(${
              currentPage - 1
            })" aria-label="Previous">
                <span aria-hidden="true">&laquo;</span>
            </a>
        </li>`;
        pagination.append(prevButton);

        // 生成页码按钮
        var startPage = Math.max(currentPage - 5, 1);
        for (var i = startPage; i <= totalPages && i <= currentPage + 5; i++) {
          var pageButton = `
            <li class="page-item ${i === currentPage ? "active" : ""}">
                <a class="page-link" href="#" onclick="fetchImages(${i})">${i}</a>
            </li>`;
          pagination.append(pageButton);
        }

        // 下一页按钮
        var nextButton = `
        <li class="page-item ${currentPage === totalPages ? "disabled" : ""}">
            <a class="page-link" href="#" onclick="fetchImages(${
              currentPage + 1
            })" aria-label="Next">
                <span aria-hidden="true">&raquo;</span>
            </a>
        </li>`;
        pagination.append(nextButton);
      }




      function jumpToPage() {
        var pageInput = document.getElementById('pageInput');
        var page = parseInt(pageInput.value, 10); // 将输入的页码转换为整数
    
        // 检查页码是否在有效范围内
        if (!isNaN(page) && page >= 1 && page <= totalPages) {
          fetchImages(page); // 调用已有的 fetchImages 函数来获取并显示指定页的图片
          pageInput.value = ''; // 清空输入框
        } else {
          // 如果页码无效，提示用户
          Swal.fire({
            title: '无效的页码',
            text: '请输入一个有效的页码（1-' + totalPages + '）',
            icon: 'warning',
            confirmButtonText: '确定'
          });
        }
      }
    
      // 确保在文档加载完成后初始化分页和输入框
      document.addEventListener('DOMContentLoaded', function() {
        // 初始加载第一页图片
        fetchImages(1);
        // 清空输入框，避免页面刷新后保留之前输入的值
        document.getElementById('pageInput').value = '';
      });
    </script>
  </head>

  <body>
    <nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top">
      <a class="navbar-brand font-weight-bolder mr-3" href="/"
        ><img src="pintereso/assets/img/logo.png"
      /></a>
      <button
        class="navbar-light navbar-toggler"
        type="button"
        data-toggle="collapse"
        data-target="#navbarsDefault"
        aria-controls="navbarsDefault"
        aria-expanded="false"
        aria-label="Toggle navigation"
      >
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarsDefault">
        <ul class="navbar-nav mr-auto align-items-center">
          <form class="bd-search hidden-sm-down">
            <input
              type="text"
              class="form-control bg-graylight border-0 font-weight-bold"
              id="search-input"
              placeholder="搜索..."
              autocomplete="off"
            />
            <div
              class="dropdown-menu bd-search-results"
              id="search-results"
            ></div>
          </form>
        </ul>
        <ul class="navbar-nav ml-auto align-items-center">
          <li class="nav-item">
            <a class="nav-link" href="/">首页</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active">个人中心</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" id="uploadHref" href="/upload">上传图片</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" onClick="logout()"
              ><img
                class="rounded-circle mr-2"
                src="pintereso/assets/img/av.png"
                width="30"
              /><span class="align-middle">退出</span></a
            >
          </li>
          <li class="nav-item dropdown">
            <a
              class="nav-link"
              href="#"
              id="dropdown02"
              data-toggle="dropdown"
              aria-haspopup="true"
              aria-expanded="false"
            >
              <svg
                style="margin-top: 10px"
                class="_3DJPT"
                version="1.1"
                viewbox="0 0 32 32"
                width="21"
                height="21"
                aria-hidden="false"
                data-reactid="71"
              >
                <path
                  d="M7 15.5c0 1.9-1.6 3.5-3.5 3.5s-3.5-1.6-3.5-3.5 1.6-3.5 3.5-3.5 3.5 1.6 3.5 3.5zm21.5-3.5c-1.9 0-3.5 1.6-3.5 3.5s1.6 3.5 3.5 3.5 3.5-1.6 3.5-3.5-1.6-3.5-3.5-3.5zm-12.5 0c-1.9 0-3.5 1.6-3.5 3.5s1.6 3.5 3.5 3.5 3.5-1.6 3.5-3.5-1.6-3.5-3.5-3.5z"
                  data-reactid="22"
                ></path>
              </svg>
            </a>
            <div
              class="dropdown-menu dropdown-menu-right shadow-lg"
              aria-labelledby="dropdown02"
            >
              <h4 class="dropdown-header display-4">
                访问站群<br />
                首页
              </h4>
              <div class="dropdown-divider"></div>
              <span class="dropdown-item"
                ><a
                  href="http:///"
                  class="btn btn-primary d-block"
                  ><i class="fa fa-download"></i> 跳转</a
                ></span
              >
            </div>
          </li>
        </ul>
      </div>
    </nav>
    <main role="main">
      <section class="mt-4 mb-5">
        <div class="container-fluid">
          <div class="row">
            <div class="card-columns" id="imageCardColumnsDiv">
              <!-- 图片卡片将在此动态生成 -->
            </div>
          </div>
          <nav aria-label="Page navigation example">
            <div class="row justify-content-center">
              <!-- 分页按钮 -->
              <ul class="pagination col-auto justify-content-center" id="pagination">
                <!-- 分页按钮将在此动态生成 -->
              </ul>
            </div>
            <!-- 新增的跳转指定页功能 -->
            <div class="row justify-content-center mt-3">
              <div class="col-auto d-flex align-items-center justify-content-center">
                <input type="number" id="pageInput" class="form-control mr-1" placeholder="" min="1" style="width: 70px;" required>
                <p id="pageCountMax" style="margin: 7px; font-size:22px;">/1</p>
                <button type="button" class="btn btn-primary" onclick="jumpToPage()">跳转</button>
              </div>
            </div>
          </nav>
        </div>
      </section>
    </main>

    <script src="pintereso/assets/js/app.js"></script>
    <script src="pintereso/assets/js/theme.js"></script>

    <footer class="footer pt-5 pb-5 text-center">
      <div class="container">
        <div class="socials-media">
          <ul class="list-unstyled">
            <li class="d-inline-block ml-1 mr-1">
              <a href="#" class="text-dark"><i class="fa fa-facebook"></i></a>
            </li>
            <li class="d-inline-block ml-1 mr-1">
              <a href="#" class="text-dark"><i class="fa fa-twitter"></i></a>
            </li>
            <li class="d-inline-block ml-1 mr-1">
              <a href="#" class="text-dark"><i class="fa fa-instagram"></i></a>
            </li>
            <li class="d-inline-block ml-1 mr-1">
              <a href="#" class="text-dark"
                ><i class="fa fa-google-plus"></i
              ></a>
            </li>
            <li class="d-inline-block ml-1 mr-1">
              <a href="#" class="text-dark"><i class="fa fa-behance"></i></a>
            </li>
            <li class="d-inline-block ml-1 mr-1">
              <a href="#" class="text-dark"><i class="fa fa-dribbble"></i></a>
            </li>
          </ul>
        </div>

        <!--
              All the links in the footer should remain intact.
              You may remove the links only if you donate:
              https://www.wowthemes.net/freebies-license/
            -->
        <p>
          ©
          <span class="credits font-weight-bold">
            <a target="_blank" class="text-dark" href="/"
              ><u>Panorama VR Image Viewer</u> by clarkhg</a
            >
          </span>
        </p>
      </div>
    </footer>
  </body>
</html>
